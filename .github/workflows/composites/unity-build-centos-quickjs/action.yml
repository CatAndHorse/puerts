name: Build CentOS-Compatible QuickJS Backend and PuerTS

description: 'Build QuickJS backend and PuerTS plugin for Linux with CentOS compatibility (GCC 12)'

runs:
  using: "composite"
  steps:
    - name: Clean previous build
      shell: bash
      run: |
        rm -rf backend-quickjs
        rm -rf unity/native_src/.backends/quickjs
        rm -rf unity/native_src/.backends/qjs_centos
        rm -rf unity/native_src/backend-quickjs
        rm -rf unity/Assets/core/upm/Plugins/

    - name: Install GCC 12
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12 make
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
        gcc --version
        g++ --version

    - name: Clone backend-quickjs repository with submodules
      shell: bash
      run: |
        # 使用 --recursive 参数克隆仓库，确保下载子模块
        # 使用 quickjs-ng 分支，该分支包含必需的扩展 API
        git clone --recursive -b quickjs-ng https://github.com/puerts/backend-quickjs.git
        cd backend-quickjs
        git log -1 --oneline
        echo "=== Checking quickjs submodule ==="
        ls -la quickjs/
        echo "=== QuickJS source files ==="
        ls quickjs/*.c 2>/dev/null || echo "Error: QuickJS source files not found"

    - name: Setup backend-quickjs directory structure
      shell: bash
      run: |
        # 将 backend-quickjs 克隆到 native_src 目录下，CMake 会直接编译 QuickJS 源代码
        cp -r backend-quickjs unity/native_src/
        echo "✓ Copied backend-quickjs to native_src/"
        ls -la unity/native_src/backend-quickjs/
        
        # 复制 quickjs.h 到 include 目录，因为多个文件都包含 "quickjs.h"
        # quickjs.h 文件在 backend-quickjs/quickjs/ 子目录中
        # 1. backend-quickjs/include/v8.h 包含 "quickjs.h"
        # 2. papi-quickjs/include/ 下的多个文件也包含 "quickjs.h"
        cp unity/native_src/backend-quickjs/quickjs/quickjs.h unity/native_src/backend-quickjs/include/quickjs.h
        echo "✓ Copied quickjs.h to backend-quickjs/include/"
        
        # 同时也复制到 papi-quickjs/include/ 目录
        cp unity/native_src/backend-quickjs/quickjs/quickjs.h unity/native_src/papi-quickjs/include/quickjs.h
        echo "✓ Copied quickjs.h to papi-quickjs/include/"
        
        # 验证文件存在
        echo "=== Verifying quickjs.h files ==="
        ls -la unity/native_src/backend-quickjs/include/quickjs.h
        ls -la unity/native_src/papi-quickjs/include/quickjs.h
        
    - name: Create .backends/quickjs directory to skip download
      shell: bash
      run: |
        # 创建空的 .backends/quickjs 目录，让 CLI 跳过下载预编译版本
        # 因为 backends.json 中 quickjs 的 link-libraries 为空
        # CMake 会直接使用 native_src/backend-quickjs/ 下的源代码编译
        mkdir -p unity/native_src/.backends/quickjs
        echo "✓ Created .backends/quickjs to skip precompiled download"

    - name: Install dependencies
      shell: bash
      run: |
        cd unity
        npm i
        cd ..

    - name: Build PuerTS with QuickJS backend
      shell: bash
      run: |
        cd unity/native_src
        # 使用 QuickJS backend，启用 WebSocket (2 = wolfSSL, 更轻量级)
        # backend-quickjs 会被 CMake 直接编译其中的 QuickJS 源代码
        # wolfSSL 是一个比 OpenSSL 更轻量级的 SSL 库
        node ../cli make --platform linux --arch x64 --backend quickjs --config Release --websocket 2
        cd ../..

    - name: Check build artifacts
      shell: bash
      run: |
        echo "=== PuerTS Linux Plugins ==="
        find ./unity/Assets/core/upm/Plugins -name "*.so" -o -name "*.a" | head -20

    - name: Archive PuerTS Linux plugins with CentOS compatibility
      uses: actions/upload-artifact@v4
      with:
        name: puerts_linux_quickjs_centos
        path: ./unity/Assets/core/upm/Plugins/x86_64/**/*
        if-no-files-found: warn
