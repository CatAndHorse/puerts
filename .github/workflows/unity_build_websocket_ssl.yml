name: Build Puerts Unity Plugin with WebSocket SSL Support

on:
  workflow_dispatch:
    inputs:
      backend:
        description: 'JavaScript Backend'
        type: choice
        options:
          - v8_9.4.146.24
          - v8_10.6.194
          - v8
        default: 'v8_9.4.146.24'
      platform:
        description: 'Target Platform'
        type: choice
        options:
          - windows
          - linux
          - osx
          - all
        default: 'windows'
      config:
        description: 'Build Configuration'
        type: choice
        options:
          - Release
          - Debug
        default: 'Release'
      ssl_backend:
        description: 'SSL Backend'
        type: choice
        options:
          - wolfssl
          - openssl
        default: 'wolfssl'
  push:
    branches:
      - unity-2.2.x
    paths:
      - unity/native_src/**
      - .github/workflows/unity_build_websocket_ssl.yml
      - .github/workflows/composites/unity-build-websocket-ssl/**

env:
  # WebSocket with SSL support
  # 0 = disabled, 1 = ws only, 2 = ws + wolfssl, 3 = ws + openssl
  WEBSOCKET_MODE: '2'

jobs:
  # ============================================
  # Windows Build Job
  # ============================================
  build-windows:
    if: github.event.inputs.platform == 'windows' || github.event.inputs.platform == 'all' || github.event_name == 'push'
    runs-on: windows-2022
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install NASM (for OpenSSL)
        if: github.event.inputs.ssl_backend == 'openssl'
        shell: powershell
        run: |
          Write-Host "Installing NASM for OpenSSL compilation..."
          $url = "https://www.nasm.us/pub/nasm/releasebuilds/2.16.01/win64/nasm-2.16.01-win64.zip"
          $output = "$env:TEMP\nasm.zip"
          $dest = "C:\nasm"
          
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          Expand-Archive -Path $output -DestinationPath $dest -Force
          Remove-Item $output
          
          # Add to PATH
          $env:Path = "C:\nasm\nasm-2.16.01;" + $env:Path
          
          # Verify installation
          & "C:\nasm\nasm-2.16.01\nasm.exe" -v
          
      - name: Install Dependencies
        shell: bash
        run: |
          cd unity
          npm install
          
      - name: Download V8 Backend
        shell: bash
        run: |
          cd unity/native_src
          node ../cli/cmd.mjs backend download ${{ github.event.inputs.backend || 'v8_9.4.146.24' }}
          
          echo "=== Verifying Backend Download ==="
          ls -la .backends/
          
      - name: Configure CMake (WolfSSL)
        if: github.event.inputs.ssl_backend == 'wolfssl' || github.event.inputs.ssl_backend == ''
        shell: bash
        run: |
          cd unity/native_src
          mkdir -p build_win_x64_v8_ws_wolfssl
          cd build_win_x64_v8_ws_wolfssl
          
          echo "=== Configuring CMake with WolfSSL ==="
          cmake .. \
            -G "Visual Studio 17 2022" -A x64 \
            -DJS_ENGINE=${{ github.event.inputs.backend || 'v8_9.4.146.24' }} \
            -DWITH_WEBSOCKET=2 \
            -DUSING_MULT_BACKEND=OFF \
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.config || 'Release' }}
          
          echo "=== Verifying CMake Configuration ==="
          grep -E "WITH_WEBSOCKET|JS_ENGINE|wolfssl" CMakeCache.txt || echo "Warning: Configuration may be incomplete"
          
      - name: Configure CMake (OpenSSL)
        if: github.event.inputs.ssl_backend == 'openssl'
        shell: bash
        run: |
          cd unity/native_src
          mkdir -p build_win_x64_v8_ws_openssl
          cd build_win_x64_v8_ws_openssl
          
          echo "=== Configuring CMake with OpenSSL ==="
          cmake .. \
            -G "Visual Studio 17 2022" -A x64 \
            -DJS_ENGINE=${{ github.event.inputs.backend || 'v8_9.4.146.24' }} \
            -DWITH_WEBSOCKET=3 \
            -DUSING_MULT_BACKEND=OFF \
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.config || 'Release' }}
          
          echo "=== Verifying CMake Configuration ==="
          grep -E "WITH_WEBSOCKET|JS_ENGINE|openssl" CMakeCache.txt || echo "Warning: Configuration may be incomplete"
          
      - name: Build Plugin
        shell: bash
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_win_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_win_x64_v8_ws_wolfssl"
          fi
          
          cd $BUILD_DIR
          
          echo "=== Building Puerts Plugin ==="
          cmake --build . --config ${{ github.event.inputs.config || 'Release' }} --parallel 4
          
          echo "=== Build Complete ==="
          ls -lh ${{ github.event.inputs.config || 'Release' }}/
          
      - name: Verify Build Output
        shell: bash
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_win_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_win_x64_v8_ws_wolfssl"
          fi
          
          cd $BUILD_DIR/${{ github.event.inputs.config || 'Release' }}
          
          echo "=== Checking Required DLLs ==="
          
          # Check main plugin
          if [ -f "puerts.dll" ]; then
            echo "âœ… puerts.dll found ($(stat -c%s puerts.dll 2>/dev/null || stat -f%z puerts.dll) bytes)"
          else
            echo "âŒ puerts.dll NOT FOUND!"
            exit 1
          fi
          
          # Check SSL library
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            if [ -f "libssl.dll" ] || [ -f "openssl.dll" ]; then
              echo "âœ… OpenSSL library found"
            else
              echo "âš ï¸  OpenSSL library not found (may be statically linked)"
            fi
          else
            if [ -f "wolfssl.dll" ] || [ -f "wolfssl.lib" ]; then
              echo "âœ… WolfSSL library found"
            else
              echo "âš ï¸  WolfSSL library not found (may be statically linked)"
            fi
          fi
          
          # List all DLLs
          echo ""
          echo "=== All DLL Files ==="
          ls -lh *.dll 2>/dev/null || echo "No DLL files found"
          
      - name: Copy to Unity Plugins Directory
        shell: bash
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_win_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_win_x64_v8_ws_wolfssl"
          fi
          
          # Create target directory
          mkdir -p ../Assets/core/upm/Plugins/Windows/x86_64
          
          # Copy DLLs
          cp $BUILD_DIR/${{ github.event.inputs.config || 'Release' }}/*.dll ../Assets/core/upm/Plugins/Windows/x86_64/ || true
          
          echo "=== Files copied to Unity Plugins ==="
          ls -lh ../Assets/core/upm/Plugins/Windows/x86_64/
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: puerts-windows-x64-websocket-ssl-${{ github.event.inputs.backend }}-${{ github.event.inputs.ssl_backend }}
          path: |
            unity/Assets/core/upm/Plugins/Windows/x86_64/*.dll
          retention-days: 30
          
      - name: Create Release Package
        shell: bash
        run: |
          cd unity/Assets/core/upm/Plugins/Windows/x86_64
          
          PACKAGE_NAME="puerts-windows-x64-websocket-ssl-${{ github.event.inputs.backend }}-${{ github.event.inputs.ssl_backend }}.zip"
          
          if command -v 7z &> /dev/null; then
            7z a -tzip $PACKAGE_NAME *.dll
          else
            zip $PACKAGE_NAME *.dll
          fi
          
          echo "=== Package Created ==="
          ls -lh $PACKAGE_NAME
          
      - name: Upload Release Package
        uses: actions/upload-artifact@v4
        with:
          name: release-package-windows
          path: unity/Assets/core/upm/Plugins/Windows/x86_64/*.zip
          retention-days: 90

  # ============================================
  # Linux Build Job
  # ============================================
  build-linux:
    if: github.event.inputs.platform == 'linux' || github.event.inputs.platform == 'all'
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            wget \
            curl
            
      - name: Install NASM (for OpenSSL)
        if: github.event.inputs.ssl_backend == 'openssl'
        run: |
          sudo apt-get install -y nasm
          nasm -v
          
      - name: Install Dependencies
        run: |
          cd unity
          npm install
          
      - name: Download V8 Backend
        run: |
          cd unity/native_src
          node ../cli/cmd.mjs backend download ${{ github.event.inputs.backend || 'v8_9.4.146.24' }}
          
          echo "=== Verifying Backend Download ==="
          ls -la .backends/
          
      - name: Configure CMake (WolfSSL)
        if: github.event.inputs.ssl_backend == 'wolfssl' || github.event.inputs.ssl_backend == ''
        run: |
          cd unity/native_src
          mkdir -p build_linux_x64_v8_ws_wolfssl
          cd build_linux_x64_v8_ws_wolfssl
          
          echo "=== Configuring CMake with WolfSSL ==="
          cmake .. \
            -G "Unix Makefiles" \
            -DJS_ENGINE=${{ github.event.inputs.backend || 'v8_9.4.146.24' }} \
            -DWITH_WEBSOCKET=2 \
            -DUSING_MULT_BACKEND=OFF \
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.config || 'Release' }}
          
          echo "=== Verifying CMake Configuration ==="
          grep -E "WITH_WEBSOCKET|JS_ENGINE|wolfssl" CMakeCache.txt || echo "Warning: Configuration may be incomplete"
          
      - name: Configure CMake (OpenSSL)
        if: github.event.inputs.ssl_backend == 'openssl'
        run: |
          cd unity/native_src
          mkdir -p build_linux_x64_v8_ws_openssl
          cd build_linux_x64_v8_ws_openssl
          
          echo "=== Configuring CMake with OpenSSL ==="
          cmake .. \
            -G "Unix Makefiles" \
            -DJS_ENGINE=${{ github.event.inputs.backend || 'v8_9.4.146.24' }} \
            -DWITH_WEBSOCKET=3 \
            -DUSING_MULT_BACKEND=OFF \
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.config || 'Release' }}
          
          echo "=== Verifying CMake Configuration ==="
          grep -E "WITH_WEBSOCKET|JS_ENGINE|openssl" CMakeCache.txt || echo "Warning: Configuration may be incomplete"
          
      - name: Build Plugin
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_linux_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_linux_x64_v8_ws_wolfssl"
          fi
          
          cd $BUILD_DIR
          
          echo "=== Building Puerts Plugin ==="
          cmake --build . --config ${{ github.event.inputs.config || 'Release' }} --parallel $(nproc)
          
          echo "=== Build Complete ==="
          ls -lh
          
      - name: Verify Build Output
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_linux_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_linux_x64_v8_ws_wolfssl"
          fi
          
          cd $BUILD_DIR
          
          echo "=== Checking Required Libraries ==="
          
          # Check main plugin
          if [ -f "libpuerts.so" ]; then
            echo "âœ… libpuerts.so found ($(stat -c%s libpuerts.so) bytes)"
          else
            echo "âŒ libpuerts.so NOT FOUND!"
            exit 1
          fi
          
          # List all shared libraries
          echo ""
          echo "=== All Shared Libraries ==="
          ls -lh *.so* 2>/dev/null || echo "No .so files found"
          
      - name: Copy to Unity Plugins Directory
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_linux_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_linux_x64_v8_ws_wolfssl"
          fi
          
          # Create target directory
          mkdir -p ../Assets/core/upm/Plugins/Linux/x86_64
          
          # Copy shared libraries
          cp $BUILD_DIR/*.so* ../Assets/core/upm/Plugins/Linux/x86_64/ || true
          
          echo "=== Files copied to Unity Plugins ==="
          ls -lh ../Assets/core/upm/Plugins/Linux/x86_64/
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: puerts-linux-x64-websocket-ssl-${{ github.event.inputs.backend }}-${{ github.event.inputs.ssl_backend }}
          path: |
            unity/Assets/core/upm/Plugins/Linux/x86_64/*.so*
          retention-days: 30

  # ============================================
  # macOS Build Job
  # ============================================
  build-macos:
    if: github.event.inputs.platform == 'osx' || github.event.inputs.platform == 'all'
    runs-on: macos-14
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Build Dependencies
        run: |
          brew install cmake ninja
          
      - name: Install NASM (for OpenSSL)
        if: github.event.inputs.ssl_backend == 'openssl'
        run: |
          brew install nasm
          nasm -v
          
      - name: Install Dependencies
        run: |
          cd unity
          npm install
          
      - name: Download V8 Backend
        run: |
          cd unity/native_src
          node ../cli/cmd.mjs backend download ${{ github.event.inputs.backend || 'v8_9.4.146.24' }}
          
          echo "=== Verifying Backend Download ==="
          ls -la .backends/
          
      - name: Configure CMake (WolfSSL)
        if: github.event.inputs.ssl_backend == 'wolfssl' || github.event.inputs.ssl_backend == ''
        run: |
          cd unity/native_src
          mkdir -p build_osx_x64_v8_ws_wolfssl
          cd build_osx_x64_v8_ws_wolfssl
          
          echo "=== Configuring CMake with WolfSSL ==="
          cmake .. \
            -G "Unix Makefiles" \
            -DJS_ENGINE=${{ github.event.inputs.backend || 'v8_9.4.146.24' }} \
            -DWITH_WEBSOCKET=2 \
            -DUSING_MULT_BACKEND=OFF \
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.config || 'Release' }}
          
          echo "=== Verifying CMake Configuration ==="
          grep -E "WITH_WEBSOCKET|JS_ENGINE|wolfssl" CMakeCache.txt || echo "Warning: Configuration may be incomplete"
          
      - name: Configure CMake (OpenSSL)
        if: github.event.inputs.ssl_backend == 'openssl'
        run: |
          cd unity/native_src
          mkdir -p build_osx_x64_v8_ws_openssl
          cd build_osx_x64_v8_ws_openssl
          
          echo "=== Configuring CMake with OpenSSL ==="
          cmake .. \
            -G "Unix Makefiles" \
            -DJS_ENGINE=${{ github.event.inputs.backend || 'v8_9.4.146.24' }} \
            -DWITH_WEBSOCKET=3 \
            -DUSING_MULT_BACKEND=OFF \
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.config || 'Release' }}
          
          echo "=== Verifying CMake Configuration ==="
          grep -E "WITH_WEBSOCKET|JS_ENGINE|openssl" CMakeCache.txt || echo "Warning: Configuration may be incomplete"
          
      - name: Build Plugin
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_osx_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_osx_x64_v8_ws_wolfssl"
          fi
          
          cd $BUILD_DIR
          
          echo "=== Building Puerts Plugin ==="
          cmake --build . --config ${{ github.event.inputs.config || 'Release' }} --parallel $(sysctl -n hw.ncpu)
          
          echo "=== Build Complete ==="
          ls -lh
          
      - name: Verify Build Output
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_osx_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_osx_x64_v8_ws_wolfssl"
          fi
          
          cd $BUILD_DIR
          
          echo "=== Checking Required Libraries ==="
          
          # Check main plugin
          if [ -f "libpuerts.dylib" ]; then
            echo "âœ… libpuerts.dylib found ($(stat -f%z libpuerts.dylib) bytes)"
          else
            echo "âŒ libpuerts.dylib NOT FOUND!"
            exit 1
          fi
          
          # List all dynamic libraries
          echo ""
          echo "=== All Dynamic Libraries ==="
          ls -lh *.dylib 2>/dev/null || echo "No .dylib files found"
          
      - name: Copy to Unity Plugins Directory
        run: |
          cd unity/native_src
          
          if [ "${{ github.event.inputs.ssl_backend }}" == "openssl" ]; then
            BUILD_DIR="build_osx_x64_v8_ws_openssl"
          else
            BUILD_DIR="build_osx_x64_v8_ws_wolfssl"
          fi
          
          # Create target directory
          mkdir -p ../Assets/core/upm/Plugins/macOS
          
          # Copy dynamic libraries
          cp $BUILD_DIR/*.dylib ../Assets/core/upm/Plugins/macOS/ || true
          
          echo "=== Files copied to Unity Plugins ==="
          ls -lh ../Assets/core/upm/Plugins/macOS/
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: puerts-macos-x64-websocket-ssl-${{ github.event.inputs.backend }}-${{ github.event.inputs.ssl_backend }}
          path: |
            unity/Assets/core/upm/Plugins/macOS/*.dylib
          retention-days: 30

  # ============================================
  # Summary Job
  # ============================================
  build-summary:
    needs: [build-windows, build-linux, build-macos]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Build Summary
        run: |
          echo "# ðŸŽ‰ Puerts WebSocket SSL Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ github.event.inputs.backend || 'v8_9.4.146.24' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ${{ github.event.inputs.platform || 'windows' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: ${{ github.event.inputs.config || 'Release' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SSL Backend**: ${{ github.event.inputs.ssl_backend || 'wolfssl' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **WebSocket Mode**: WITH_WEBSOCKET=${{ env.WEBSOCKET_MODE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: ${{ needs.build-windows.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linux: ${{ needs.build-linux.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.build-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Features" >> $GITHUB_STEP_SUMMARY
          echo "âœ… WebSocket Support (ws://)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… WebSocket Secure Support (wss://)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… TLS/SSL Encryption" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download the compiled plugins from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
