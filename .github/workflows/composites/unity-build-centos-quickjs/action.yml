name: Build CentOS-Compatible QuickJS Backend and PuerTS

description: 'Build QuickJS backend and PuerTS plugin for Linux with CentOS compatibility (GCC 12)'

runs:
  using: "composite"
  steps:
    - name: Clean previous build
      shell: bash
      run: |
        rm -rf backend-quickjs
        rm -rf unity/native_src/.backends/qjs_centos
        rm -rf unity/Assets/core/upm/Plugins/

    - name: Install GCC 12
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12 make
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
        gcc --version
        g++ --version

    - name: Clone backend-quickjs repository
      shell: bash
      run: |
        git clone https://github.com/puerts/backend-quickjs.git
        cd backend-quickjs
        git log -1 --oneline

    - name: Build QuickJS backend with CentOS compatibility
      shell: bash
      run: |
        cd backend-quickjs
        # 使用 make 编译 QuickJS
        make clean || true
        make
        # 确认编译产物
        ls -lh libquickjs.a || echo "Warning: libquickjs.a not found"
        find . -name "*.a" -o -name "*.so" | head -20

    - name: Create backend directory structure
      shell: bash
      run: |
        cd unity/native_src
        mkdir -p .backends/qjs_centos
        mkdir -p .backends/qjs_centos/Inc
        mkdir -p .backends/qjs_centos/Lib/linux/x64
        cd ../..

    - name: Copy QuickJS backend artifacts
      shell: bash
      run: |
        # 复制 QuickJS 库文件
        if [ -f backend-quickjs/libquickjs.a ]; then
          cp backend-quickjs/libquickjs.a unity/native_src/.backends/qjs_centos/Lib/linux/x64/
          echo "✓ Copied libquickjs.a"
        else
          echo "✗ Error: libquickjs.a not found"
          find backend-quickjs -name "*.a"
          exit 1
        fi
        
        # 复制 QuickJS 头文件
        if [ -f backend-quickjs/quickjs.h ]; then
          cp backend-quickjs/quickjs.h unity/native_src/.backends/qjs_centos/Inc/
          echo "✓ Copied quickjs.h"
        else
          echo "✗ Error: quickjs.h not found"
          find backend-quickjs -name "*.h"
          exit 1
        fi
        
        # 查找并复制其他可能需要的头文件
        find backend-quickjs -name "*.h" -exec cp {} unity/native_src/.backends/qjs_centos/Inc/ \; 2>/dev/null || true
        
        echo "Backend directory structure:"
        ls -lR unity/native_src/.backends/qjs_centos/

    - name: Install dependencies
      shell: bash
      run: |
        cd unity
        npm i
        cd ..

    - name: Build PuerTS with custom QuickJS backend
      shell: bash
      run: |
        cd unity/native_src
        # 使用自定义编译的 QuickJS backend，启用 WebSocket (3 = OpenSSL)
        node ../cli make --platform linux --arch x64 --backend qjs_centos --config Release --websocket 3
        cd ../..

    - name: Check build artifacts
      shell: bash
      run: |
        echo "=== PuerTS Linux Plugins ==="
        find ./unity/Assets/core/upm/Plugins -name "*.so" -o -name "*.a" | head -20

    - name: Archive PuerTS Linux plugins with CentOS compatibility
      uses: actions/upload-artifact@v4
      with:
        name: puerts_linux_quickjs_centos
        path: ./unity/Assets/core/upm/Plugins/linux/**/*
        if-no-files-found: warn
