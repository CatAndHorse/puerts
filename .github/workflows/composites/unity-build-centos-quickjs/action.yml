name: Build CentOS-Compatible QuickJS Backend and PuerTS

description: 'Build QuickJS backend and PuerTS plugin for Linux with CentOS compatibility (GCC 12)'

runs:
  using: "composite"
  steps:
    - name: Clean previous build
      shell: bash
      run: |
        rm -rf backend-quickjs
        rm -rf unity/native_src/.backends/qjs_centos
        rm -rf unity/native_src/backend-quickjs
        rm -rf unity/Assets/core/upm/Plugins/

    - name: Install GCC 12
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12 make
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
        gcc --version
        g++ --version

    - name: Clone backend-quickjs repository
      shell: bash
      run: |
        git clone https://github.com/puerts/backend-quickjs.git
        cd backend-quickjs
        git log -1 --oneline

    - name: Setup backend-quickjs directory structure
      shell: bash
      run: |
        # 将 backend-quickjs 克隆到 native_src 目录下，CMake 会直接编译 QuickJS 源代码
        cp -r backend-quickjs unity/native_src/
        echo "✓ Copied backend-quickjs to native_src/"
        ls -la unity/native_src/backend-quickjs/

    - name: Install dependencies
      shell: bash
      run: |
        cd unity
        npm i
        cd ..

    - name: Build PuerTS with QuickJS backend
      shell: bash
      run: |
        cd unity/native_src
        # 使用 QuickJS backend，启用 WebSocket (3 = OpenSSL)
        # backend-quickjs 会被 CMake 直接编译其中的 QuickJS 源代码
        node ../cli make --platform linux --arch x64 --backend quickjs --config Release --websocket 3
        cd ../..

    - name: Check build artifacts
      shell: bash
      run: |
        echo "=== PuerTS Linux Plugins ==="
        find ./unity/Assets/core/upm/Plugins -name "*.so" -o -name "*.a" | head -20

    - name: Archive PuerTS Linux plugins with CentOS compatibility
      uses: actions/upload-artifact@v4
      with:
        name: puerts_linux_quickjs_centos
        path: ./unity/Assets/core/upm/Plugins/linux/**/*
        if-no-files-found: warn
