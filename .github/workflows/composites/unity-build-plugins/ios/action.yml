name: build ios unity plugin

inputs:
  backend:
    description: 'js backend'     
    required: true
  config:
    type: choice
    description: Release Or Debug
    default: 'Release'
    options:
    - Release
    - Debug
  websocket:
    description: enable websocket
    default: '0'
  build_proj_dir:
    description: 'build project dir'     
    required: false
    default: 'native_src'
  GITHUB_TOKEN:
    required:

runs:
  using: "composite"
  steps:
    - name: Build
      shell: bash
      run: |
        cd unity
        npm i
        cd ${{ inputs.build_proj_dir }}
        node ../cli make --platform ios --backend ${{ inputs.backend }} --config ${{ inputs.config }} --websocket ${{ inputs.websocket }}
    - name: Post-Build Processing
      shell: bash
      run: |
        echo "=== iOS Post-Build Processing ==="
        PLUGINS_DIR="./unity/Assets/core/upm/Plugins/iOS"
        
        if [ -d "$PLUGINS_DIR" ]; then
          cd "$PLUGINS_DIR"
          
          # Clean up unnecessary .meta files (keep only those with corresponding .a files)
          echo "Cleaning up unnecessary .meta files..."
          REMOVED_COUNT=0
          for meta_file in *.meta; do
            if [ -f "$meta_file" ]; then
              lib_file="${meta_file%.meta}"
              if [ ! -f "$lib_file" ]; then
                echo "  Removing: $meta_file (no corresponding library)"
                rm -f "$meta_file"
                ((REMOVED_COUNT++))
              fi
            fi
          done
          echo "✓ Removed $REMOVED_COUNT unnecessary .meta files"
          
          # Summary
          echo ""
          echo "Final libraries:"
          ls -lh *.a 2>/dev/null || echo "No .a files found"
          echo ""
          echo "Final .meta files:"
          ls -1 *.meta 2>/dev/null || echo "No .meta files found"
          
          # Check if wolfssl library exists
          if [ -f "libwolfssl.a" ]; then
            echo ""
            echo "✓ WolfSSL library found (required for WebSocket SSL support)"
          else
            echo ""
            echo "⚠ Warning: libwolfssl.a not found. WebSocket SSL may not work."
          fi
        else
          echo "Warning: $PLUGINS_DIR not found"
        fi
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        path: ./unity/Assets/core/upm/Plugins/iOS/**/*
        name: Unity_Plugins_${{ inputs.backend }}_${{ inputs.config }}_ios
    - name: Clean
      shell: bash
      run: rm -rf ./unity/Assets/core/upm/Plugins/**/*